<template>
  <div class="home py-12">
    <div class="container mx-auto px-4">
      <!-- æƒ…ä¾£ä¿¡æ¯å’Œå€’è®¡æ—¶ -->
        
        <!-- æ‹çˆ±æ—¶é—´å€’è®¡æ—¶ -->
        <div class="mt-1 text-center">
          <div class="text-2xl bg-gradient-to-r from-red-500 to-blue-500 bg-clip-text text-transparent mb-2">æˆ‘ä»¬é£é›¨åŒèˆŸå·²ç»ä¸€èµ·èµ°è¿‡</div>
          <div class="text-2xl font-bold bg-gradient-to-r from-red-500 to-blue-500 bg-clip-text text-transparent mb-2">{{ formattedLoveTime }}</div>
        </div>
        
        <!-- ç»“å©šå‘¨å¹´å€’è®¡æ—¶ -->
        <div v-if="weddingDate" class="mt-4 text-center">
          <div class="text-gray-600">
            è·ç¦»
            <span class="font-bold">ç»“å©š</span>
            <span class="text-red-500 font-bold">{{ weddingAnniversary }}</span>
            å‘¨å¹´çºªå¿µæ—¥è¿˜æœ‰
            <span class="text-red-500 font-bold">{{ daysUntilWeddingAnniversary }}</span>
            å¤©
          </div>
        </div>
        
        <!-- é‡è¦æ—¥æœŸå€’è®¡æ—¶ -->
        <div v-if="importantDays.length > 0" class="mt-1 text-center">
          <div v-for="(day, index) in importantDays" :key="index" class="text-gray-600 mb-2">
            è·ç¦»
            <span class="font-bold">{{ day.name }}</span>
            è¿˜æœ‰
            <span class="text-red-500 font-bold">{{ day.daysRemaining }}</span>
            å¤©
          </div>
        </div>
        
        <!-- åŠŸèƒ½å¡ç‰‡ -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
          <!-- ç¥ç¦å¢™å¡ç‰‡ -->
          <router-link to="/message" class="bg-white rounded-xl shadow-lg p-8 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center space-x-6">
              <img src="/images/bless.svg" alt="ç¥ç¦å¢™" class="w-12 h-12 text-primary">
              <div>
                <h3 class="text-lg font-bold text-gray-800">ç¥ç¦å¢™</h3>
                <p class="text-sm text-gray-500">ğŸ’Œå†™ä¸‹å¯¹æˆ‘ä»¬çš„ç¥ç¦å§</p>
              </div>
            </div>
          </router-link>
          
          <!-- å¹¸ç¦è·¯å¡ç‰‡ -->
          <router-link to="/timeline" class="bg-white rounded-xl shadow-lg p-8 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center space-x-6">
              <img src="/images/time.svg" alt="å¹¸ç¦è·¯" class="w-12 h-12 text-primary">
              <div>
                <h3 class="text-lg font-bold text-gray-800">å¹¸ç¦è·¯</h3>
                <p class="text-sm text-gray-500">ğŸ“œè®°å½•ä¸€èµ·çš„ç¾å¥½æ—¶å…‰</p>
              </div>
            </div>
          </router-link>
          
          <!-- ç›¸å†Œå¡ç‰‡ -->
          <router-link to="/gallery" class="bg-white rounded-xl shadow-lg p-8 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center space-x-6">
              <img src="/images/photo.svg" alt="ç›¸å†Œ" class="w-12 h-12 text-primary">
              <div>
                <h3 class="text-lg font-bold text-gray-800">ç›¸å†Œ</h3>
                <p class="text-sm text-gray-500">ğŸ“·ç•™ä½æˆ‘ä»¬çš„ç¬é—´</p>
              </div>
            </div>
          </router-link>
          
          <!-- ç‚¹ç‚¹æ»´æ»´å¡ç‰‡ -->
          <router-link to="/moments" class="bg-white rounded-xl shadow-lg p-8 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center space-x-6">
              <img src="/images/shuoshuo.svg" alt="ç‚¹ç‚¹æ»´æ»´" class="w-12 h-12 text-primary">
              <div>
                <h3 class="text-lg font-bold text-gray-800">ç‚¹ç‚¹æ»´æ»´</h3>
                <p class="text-sm text-gray-500">ğŸ“è®°å½•ä½ æˆ‘ç”Ÿæ´»çš„ç‚¹æ»´</p>
              </div>
            </div>
          </router-link>
          
          <!-- çˆ±æƒ…æ¸…å•å¡ç‰‡ -->
          <router-link to="/love-list" class="bg-white rounded-xl shadow-lg p-8 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center space-x-6">
              <img src="/images/loveList.svg" alt="çˆ±æƒ…æ¸…å•" class="w-12 h-12 text-primary">
              <div>
                <h3 class="text-lg font-bold text-gray-800">çˆ±æƒ…æ¸…å•</h3>
                <p class="text-sm text-gray-500">ğŸ“‹çˆ±æƒ…ä¸€æ­¥æ­¥</p>
              </div>
            </div>
          </router-link>
          
          <!-- å…³äºæˆ‘ä»¬å¡ç‰‡ -->
          <router-link to="/about" class="bg-white rounded-xl shadow-lg p-8 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center space-x-6">
              <img src="/images/about.svg" alt="å…³äºæˆ‘ä»¬" class="w-12 h-12 text-primary">
              <div>
                <h3 class="text-lg font-bold text-gray-800">å…³äºæˆ‘ä»¬</h3>
                <p class="text-sm text-gray-500">ğŸ’æˆ‘ä»¬çš„ç»å†</p>
              </div>
            </div>
          </router-link>
        </div>     

      


    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed, onUnmounted } from 'vue'
import { getConfigFromWikiCloud } from '../utils/api'

// é…ç½®æ•°æ®
const config = ref({})

// æ‹çˆ±å¼€å§‹æ—¥æœŸ
const loveDate = ref('2023-01-15')

// ç»“å©šæ—¥æœŸ
const weddingDate = ref('2015-03-03')



// ç²¾é€‰ç…§ç‰‡
const featuredPhotos = ref([
  '/images/01.png',
  '/images/02.png',
  '/images/03.png',
  '/images/04.png',
  '/images/05.png'
])

// çˆ±æƒ…å®£è¨€
const loveDeclaration = ref('æˆ‘èƒ½æƒ³åˆ°æœ€æµªæ¼«çš„äº‹ï¼Œå°±æ˜¯å’Œä½ ä¸€èµ·æ…¢æ…¢å˜è€ã€‚')



// é‡è¦æ—¥æœŸå€’è®¡æ—¶
const importantDays = ref([])

// è®¡ç®—æ‹çˆ±æ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰
const calculateLoveTime = () => {
  const today = new Date()
  const startDate = new Date(loveDate.value)
  
  // è®¡ç®—å¹´
  const years = today.getFullYear() - startDate.getFullYear()
  
  // è®¡ç®—æœˆ
  let months = today.getMonth() - startDate.getMonth()
  if (today.getDate() < startDate.getDate()) {
    months--
  }
  if (months < 0) {
    months += 12
  }
  
  // è®¡ç®—æ—¥
  const tempDate = new Date(today)
  tempDate.setMonth(today.getMonth() - 1)
  let days = 0
  if (today.getDate() >= startDate.getDate()) {
    days = today.getDate() - startDate.getDate()
  } else {
    days = startDate.getDate() - today.getDate()
    tempDate.setDate(0)
    days = tempDate.getDate() - days
  }
  
  // è®¡ç®—æ—¶ã€åˆ†ã€ç§’
  const timeDiff = today.getTime() - startDate.getTime()
  const totalSeconds = Math.floor(timeDiff / 1000)
  const hours = Math.floor(totalSeconds % (3600 * 24) / 3600)
  const minutes = Math.floor(totalSeconds % 3600 / 60)
  const seconds = Math.floor(totalSeconds % 60)
  
  return {
    years,
    months,
    days,
    hours,
    minutes,
    seconds
  }
}

// æ‹çˆ±æ—¶é—´å¯¹è±¡
const loveTime = ref(calculateLoveTime())

// è®¡ç®—ç»“å©šå‘¨å¹´ç›¸å…³ä¿¡æ¯
const calculateWeddingAnniversary = () => {
  const today = new Date()
  const wedding = new Date(weddingDate.value)
  
  // è®¡ç®—å½“å‰ç»“å©šå‘¨å¹´æ•°
  const currentYear = today.getFullYear()
  const weddingYear = wedding.getFullYear()
  let anniversary = currentYear - weddingYear
  
  // æ£€æŸ¥ä»Šå¹´çš„ç»“å©šçºªå¿µæ—¥æ˜¯å¦å·²ç»è¿‡äº†
  const thisYearsAnniversary = new Date(currentYear, wedding.getMonth(), wedding.getDate())
  if (today < thisYearsAnniversary) {
    anniversary--
  }
  
  // è®¡ç®—ä¸‹ä¸€ä¸ªç»“å©šçºªå¿µæ—¥
  let nextAnniversaryDate = new Date(currentYear, wedding.getMonth(), wedding.getDate())
  if (today > nextAnniversaryDate) {
    nextAnniversaryDate.setFullYear(currentYear + 1)
  }
  
  // è®¡ç®—è·ç¦»ä¸‹ä¸€ä¸ªç»“å©šçºªå¿µæ—¥çš„å¤©æ•°
  const timeDiff = nextAnniversaryDate.getTime() - today.getTime()
  const daysUntilNext = Math.ceil(timeDiff / (1000 * 3600 * 24))
  
  return {
    anniversary,
    daysUntilNext
  }
}

// ç»“å©šå‘¨å¹´ä¿¡æ¯
const weddingInfo = ref(calculateWeddingAnniversary())

// è®¡ç®—å±æ€§ï¼šå½“å‰ç»“å©šå‘¨å¹´æ•°
const weddingAnniversary = computed(() => {
  return weddingInfo.value.anniversary + 1 // +1 è¡¨ç¤ºä¸‹ä¸€ä¸ªå‘¨å¹´
})

// è®¡ç®—å±æ€§ï¼šè·ç¦»ä¸‹ä¸€ä¸ªç»“å©šå‘¨å¹´çš„å¤©æ•°
const daysUntilWeddingAnniversary = computed(() => {
  return weddingInfo.value.daysUntilNext
})

// å®šæ—¶å™¨
let timer = null

onMounted(async () => {
  // ä»ç»´åŸºäº‘è¡¨æ ¼è·å–é…ç½®
  const fetchedConfig = await getConfigFromWikiCloud()
  config.value = fetchedConfig
  
  // æ›´æ–°æ‹çˆ±å¼€å§‹æ—¥æœŸ
  if (config.value.loveDate) {
    loveDate.value = config.value.loveDate
  }
  
  // æ›´æ–°ç»“å©šæ—¥æœŸ
  if (config.value.weddingDate) {
    weddingDate.value = config.value.weddingDate
  }
  

  
  // æ›´æ–°ç²¾é€‰ç…§ç‰‡
  if (config.value.featuredPhotos) {
    try {
      const photos = JSON.parse(config.value.featuredPhotos)
      if (Array.isArray(photos)) {
        featuredPhotos.value = photos
      }
    } catch (e) {
      console.error('è§£æç²¾é€‰ç…§ç‰‡å¤±è´¥:', e)
    }
  }
  
  // æ›´æ–°çˆ±æƒ…å®£è¨€
  if (config.value.sayLove) {
    loveDeclaration.value = config.value.sayLove
  }
  
  // æ›´æ–°é‡è¦æ—¥æœŸå€’è®¡æ—¶
  if (config.value.importantDay) {
    // è§£æé‡è¦æ—¥æœŸ
    const importantDaysData = config.value.importantDay.split(';').map(item => {
      const [name, dateStr] = item.split(',').map(str => str.trim())
      return { name, dateStr }
    }).filter(item => item.name && item.dateStr)
    
    // è®¡ç®—æ¯ä¸ªé‡è¦æ—¥æœŸçš„å‰©ä½™å¤©æ•°
    const today = new Date()
    const currentYear = today.getFullYear()
    
    const calculatedDays = importantDaysData.map(day => {
      const [month, dayOfMonth] = day.dateStr.split('-').map(Number)
      let targetDate = new Date(currentYear, month - 1, dayOfMonth)
      
      // å¦‚æœä»Šå¹´çš„æ—¥æœŸå·²ç»è¿‡äº†ï¼Œè®¡ç®—æ˜å¹´çš„
      if (today > targetDate) {
        targetDate = new Date(currentYear + 1, month - 1, dayOfMonth)
      }
      
      // è®¡ç®—å‰©ä½™å¤©æ•°
      const timeDiff = targetDate.getTime() - today.getTime()
      const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24))
      
      return {
        name: day.name,
        daysRemaining
      }
    })
    
    importantDays.value = calculatedDays
  }
  
  // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
  timer = setInterval(() => {
    loveTime.value = calculateLoveTime()
    weddingInfo.value = calculateWeddingAnniversary()
  }, 1000)
})

// ç»„ä»¶å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
onUnmounted(() => {
  if (timer) {
    clearInterval(timer)
  }
})

// æ ¼å¼åŒ–æ˜¾ç¤ºæ—¶é—´
const formattedLoveTime = computed(() => {
  const { years, months, days, hours, minutes, seconds } = loveTime.value
  return `${years}å¹´${months}æœˆ${days}æ—¥${hours.toString().padStart(2, '0')}æ—¶${minutes.toString().padStart(2, '0')}åˆ†${seconds.toString().padStart(2, '0')}ç§’`
})
</script>


